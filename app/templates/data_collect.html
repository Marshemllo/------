<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据采集管理</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='layui/layui-v2.13.2/layui/css/layui.css') }}">
    <style>
        body { padding: 15px; background: #f2f2f2; }
        .search-box { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .progress-box { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 15px; display: none; }
        .data-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .data-card { background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s; position: relative; }
        .data-card:hover { transform: translateY(-3px); box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .data-card .cover { width: 100%; height: 160px; object-fit: cover; background: #f0f0f0; display: block; }
        .data-card .cover-placeholder { width: 100%; height: 160px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: #fff; font-size: 48px; }
        .data-card .info { padding: 12px; }
        .data-card .title { font-size: 14px; font-weight: 600; color: #333; margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4; height: 40px; }
        .data-card .meta { font-size: 12px; color: #999; display: flex; justify-content: space-between; align-items: center; }
        .data-card .source { max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .data-card .actions { padding: 10px 12px; border-top: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .data-card .checkbox-wrap { display: flex; align-items: center; }
        .deep-status { font-size: 12px; padding: 2px 8px; border-radius: 10px; }
        .deep-status.done { background: #d4edda; color: #155724; }
        .deep-status.pending { background: #fff3cd; color: #856404; }
        .toolbar { background: #fff; padding: 15px 20px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .result-count { color: #666; font-size: 14px; }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-state i { font-size: 64px; margin-bottom: 20px; color: #ddd; }
        .progress-info { display: flex; align-items: center; gap: 15px; }
        .progress-text { color: #666; font-size: 14px; }
    </style>
</head>
<body>
    <!-- 搜索采集区域 -->
    <div class="search-box">
        <div class="layui-form">
            <div class="layui-form-item" style="margin-bottom: 0;">
                <div class="layui-inline" style="width: 400px;">
                    <label class="layui-form-label">采集关键词</label>
                    <div class="layui-input-block">
                        <input type="text" id="keyword" placeholder="请输入要采集的关键词或需求" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">搜索引擎</label>
                    <div class="layui-input-inline" style="width: 120px;">
                        <select id="engine">
                            <option value="bing">必应</option>
                            <option value="baidu">百度</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">采集页数</label>
                    <div class="layui-input-inline" style="width: 100px;">
                        <select id="pages">
                            <option value="1">1页</option>
                            <option value="2">2页</option>
                            <option value="3">3页</option>
                            <option value="5">5页</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <button class="layui-btn layui-btn-normal" id="btn-collect">
                        <i class="layui-icon layui-icon-search"></i> 开始采集
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 进度提示 -->
    <div class="progress-box" id="progress-box">
        <div class="progress-info">
            <div class="layui-progress layui-progress-big" lay-showPercent="true" style="flex: 1;">
                <div class="layui-progress-bar layui-bg-blue" id="progress-bar" lay-percent="0%"></div>
            </div>
            <span class="progress-text" id="progress-text">准备采集...</span>
        </div>
    </div>

    <!-- 工具栏 -->
    <div class="toolbar" id="toolbar" style="display: none;">
        <div>
            <button class="layui-btn layui-btn-sm" id="btn-select-all">
                <i class="layui-icon layui-icon-ok"></i> 全选
            </button>
            <button class="layui-btn layui-btn-sm layui-btn-primary" id="btn-select-none">
                取消全选
            </button>
            <button class="layui-btn layui-btn-sm layui-btn-warm" id="btn-save-selected">
                <i class="layui-icon layui-icon-download-circle"></i> 保存选中数据
            </button>
            <button class="layui-btn layui-btn-sm" id="btn-save-all">
                <i class="layui-icon layui-icon-download-circle"></i> 保存全部数据
            </button>
            <span class="result-count" id="result-count"></span>
        </div>
        <div>
            <button class="layui-btn layui-btn-sm layui-btn-danger" id="btn-clear">
                <i class="layui-icon layui-icon-delete"></i> 清空结果
            </button>
        </div>
    </div>

    <!-- 数据橱窗 -->
    <div class="data-grid" id="data-grid">
        <div class="empty-state" id="empty-state">
            <i class="layui-icon layui-icon-search"></i>
            <p>请输入关键词开始采集数据</p>
        </div>
    </div>

    <script src="{{ url_for('static', filename='layui/layui-v2.13.2/layui/layui.js') }}"></script>
    <script>
    layui.use(['form', 'layer', 'element'], function(){
        var form = layui.form;
        var layer = layui.layer;
        var element = layui.element;
        var $ = layui.$;

        var currentTaskId = null;
        var collectedData = [];

        // 开始采集
        $('#btn-collect').on('click', function(){
            var keyword = $('#keyword').val().trim();
            if(!keyword){
                layer.msg('请输入采集关键词', {icon: 2});
                return;
            }

            var engine = $('#engine').val();
            var pages = parseInt($('#pages').val());

            // 显示进度
            $('#progress-box').show();
            $('#toolbar').hide();
            $('#data-grid').html('');
            updateProgress(0, '正在初始化采集任务...');

            // 禁用按钮
            $('#btn-collect').prop('disabled', true).html('<i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i> 采集中...');

            // 发起采集请求
            $.ajax({
                url: '/api/collect/start',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    keyword: keyword,
                    engine: engine,
                    pages: pages
                }),
                success: function(res){
                    if(res.code === 0){
                        currentTaskId = res.data.task_id;
                        // 开始轮询进度
                        pollProgress(currentTaskId);
                    } else {
                        layer.msg(res.msg, {icon: 2});
                        resetCollectBtn();
                        $('#progress-box').hide();
                    }
                },
                error: function(){
                    layer.msg('请求失败', {icon: 2});
                    resetCollectBtn();
                    $('#progress-box').hide();
                }
            });
        });

        // 轮询采集进度
        function pollProgress(taskId){
            $.get('/api/collect/progress/' + taskId, function(res){
                if(res.code === 0){
                    var data = res.data;
                    updateProgress(data.progress, data.message);

                    if(data.status === 'completed'){
                        // 采集完成，加载数据
                        loadCollectedData(taskId);
                        resetCollectBtn();
                    } else if(data.status === 'failed'){
                        layer.msg('采集失败: ' + data.message, {icon: 2});
                        resetCollectBtn();
                        $('#progress-box').hide();
                    } else {
                        // 继续轮询
                        setTimeout(function(){ pollProgress(taskId); }, 500);
                    }
                }
            });
        }

        // 更新进度条
        function updateProgress(percent, text){
            element.progress('progress-bar', percent + '%');
            $('#progress-text').text(text);
        }

        // 重置采集按钮
        function resetCollectBtn(){
            $('#btn-collect').prop('disabled', false).html('<i class="layui-icon layui-icon-search"></i> 开始采集');
        }

        // 加载采集数据
        function loadCollectedData(taskId){
            $.get('/api/collect/data/' + taskId, function(res){
                if(res.code === 0){
                    collectedData = res.data;
                    renderDataGrid(collectedData);
                    $('#progress-box').hide();
                    $('#toolbar').show();
                    $('#result-count').text('共采集到 ' + collectedData.length + ' 条数据');
                }
            });
        }

        // 渲染数据橱窗
        function renderDataGrid(data){
            if(data.length === 0){
                $('#data-grid').html('<div class="empty-state"><i class="layui-icon layui-icon-face-cry"></i><p>未采集到数据</p></div>');
                return;
            }

            var html = '';
            data.forEach(function(item){
                var coverHtml = item.cover ? 
                    '<a href="' + item.link + '" target="_blank"><img class="cover" src="' + item.cover + '" onerror="this.parentElement.innerHTML=\'<div class=cover-placeholder><i class=layui-icon layui-icon-picture></i></div>\'"></a>' :
                    '<a href="' + item.link + '" target="_blank"><div class="cover-placeholder"><i class="layui-icon layui-icon-picture"></i></div></a>';
                
                var deepStatus = item.deep_crawled ? 
                    '<span class="deep-status done">已深度采集</span>' :
                    '<span class="deep-status pending">未深度采集</span>';

                html += '<div class="data-card" data-id="' + item.id + '">' +
                    coverHtml +
                    '<div class="info">' +
                        '<div class="title" title="' + item.title + '">' + item.title + '</div>' +
                        '<div class="meta">' +
                            '<span class="source">' + (item.source || '未知来源') + '</span>' +
                            deepStatus +
                        '</div>' +
                    '</div>' +
                    '<div class="actions">' +
                        '<div class="checkbox-wrap">' +
                            '<input type="checkbox" class="item-checkbox" data-id="' + item.id + '" lay-skin="primary">' +
                            '<span style="margin-left:5px;font-size:12px;color:#999;">选择</span>' +
                        '</div>' +
                        '<button class="layui-btn layui-btn-xs layui-btn-normal btn-deep-crawl" data-id="' + item.id + '" ' + (item.deep_crawled ? 'disabled' : '') + '>' +
                            (item.deep_crawled ? '已采集' : '深度采集') +
                        '</button>' +
                    '</div>' +
                '</div>';
            });
            $('#data-grid').html(html);
            form.render('checkbox');
        }

        // 深度采集
        $(document).on('click', '.btn-deep-crawl', function(){
            var id = $(this).data('id');
            var btn = $(this);
            
            btn.prop('disabled', true).text('采集中...');
            
            $.ajax({
                url: '/api/collect/deep/' + id,
                type: 'POST',
                success: function(res){
                    if(res.code === 0){
                        layer.msg('深度采集完成', {icon: 1});
                        btn.text('已采集').addClass('layui-btn-disabled');
                        // 更新状态
                        btn.closest('.data-card').find('.deep-status').removeClass('pending').addClass('done').text('已深度采集');
                        // 更新本地数据
                        for(var i = 0; i < collectedData.length; i++){
                            if(collectedData[i].id === id){
                                collectedData[i].deep_crawled = true;
                                collectedData[i].content = res.data.content;
                                break;
                            }
                        }
                    } else {
                        layer.msg(res.msg, {icon: 2});
                        btn.prop('disabled', false).text('深度采集');
                    }
                },
                error: function(){
                    layer.msg('请求失败', {icon: 2});
                    btn.prop('disabled', false).text('深度采集');
                }
            });
        });

        // 全选
        $('#btn-select-all').on('click', function(){
            $('.item-checkbox').prop('checked', true);
            form.render('checkbox');
        });

        // 取消全选
        $('#btn-select-none').on('click', function(){
            $('.item-checkbox').prop('checked', false);
            form.render('checkbox');
        });

        // 保存选中数据
        $('#btn-save-selected').on('click', function(){
            var ids = [];
            $('.item-checkbox:checked').each(function(){
                ids.push($(this).data('id'));
            });

            if(ids.length === 0){
                layer.msg('请先选择要保存的数据', {icon: 2});
                return;
            }

            saveData(ids);
        });

        // 保存全部数据
        $('#btn-save-all').on('click', function(){
            var ids = collectedData.map(function(item){ return item.id; });
            if(ids.length === 0){
                layer.msg('没有可保存的数据', {icon: 2});
                return;
            }
            saveData(ids);
        });

        // 保存数据到数据库
        function saveData(ids){
            layer.confirm('确定要保存选中的 ' + ids.length + ' 条数据吗？', {icon: 3, title: '确认保存'}, function(index){
                layer.close(index);
                
                var loadIndex = layer.load(1, {shade: [0.3, '#000']});
                
                $.ajax({
                    url: '/api/collect/save',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ ids: ids }),
                    success: function(res){
                        layer.close(loadIndex);
                        if(res.code === 0){
                            layer.msg('成功保存 ' + res.data.saved_count + ' 条数据', {icon: 1});
                            // 标记已保存的卡片
                            ids.forEach(function(id){
                                $('.data-card[data-id="' + id + '"]').css('opacity', '0.6');
                            });
                        } else {
                            layer.msg(res.msg, {icon: 2});
                        }
                    },
                    error: function(){
                        layer.close(loadIndex);
                        layer.msg('保存失败', {icon: 2});
                    }
                });
            });
        }

        // 清空结果
        $('#btn-clear').on('click', function(){
            layer.confirm('确定要清空当前采集结果吗？', {icon: 3, title: '确认清空'}, function(index){
                layer.close(index);
                collectedData = [];
                $('#data-grid').html('<div class="empty-state"><i class="layui-icon layui-icon-search"></i><p>请输入关键词开始采集数据</p></div>');
                $('#toolbar').hide();
            });
        });

        form.render();
    });
    </script>
</body>
</html>
